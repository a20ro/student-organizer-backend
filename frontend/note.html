<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Editor - Student Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #f8fafc;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }   
        
        .sidebar {
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 3px solid #60a5fa;
        }
        
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }
        
        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
        }
        
        .editor-pane {
            flex: 1;
            overflow-y: auto;
        }
        
        .preview-pane {
            display: none;
        }
        
        .markdown-editor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 2rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            background: #ffffff;
        }
        
        .markdown-preview {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .markdown-preview h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        
        .markdown-preview h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }
        
        .markdown-preview h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .markdown-preview p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        
        .markdown-preview code {
            background: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .markdown-preview pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        
        .markdown-preview pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        
        .markdown-preview ul, .markdown-preview ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        
        .markdown-preview blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin-left: 0;
            color: #6b7280;
            font-style: italic;
        }
        
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar text-white p-6">
        <!-- Logo -->
        <div class="flex items-center mb-10">
            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center mr-3 shadow-lg">
                <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold">Student Tracker</h1>
                <p class="text-xs text-blue-200">Organize & Succeed</p>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="space-y-1">
            <a href="index.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-home w-5 mr-3"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="semesters.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-calendar-alt w-5 mr-3"></i>
                <span class="font-medium">Semesters</span>
            </a>
            <a href="courses.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-book w-5 mr-3"></i>
                <span class="font-medium">Courses</span>
            </a>
            <a href="assessments.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-clipboard-list w-5 mr-3"></i>
                <span class="font-medium">Assessments</span>
            </a>
            <a href="notes.html" class="sidebar-item active flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-sticky-note w-5 mr-3"></i>
                <span class="font-medium">Notes</span>
            </a>
            <a href="/events.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-calendar w-5 mr-3"></i>
                <span class="font-medium">Events</span>
            </a>
            <a href="budget.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-wallet w-5 mr-3"></i>
                <span class="font-medium">Budget</span>
            </a>
            <a href="#" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-bullseye w-5 mr-3"></i>
                <span class="font-medium">Goals</span>
            </a>
            <a href="#" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-tasks w-5 mr-3"></i>
                <span class="font-medium">Tasks</span>
            </a>
            <a href="#" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-chart-line w-5 mr-3"></i>
                <span class="font-medium">Habits</span>
            </a>
            <div class="pt-6 mt-6 border-t border-blue-400 border-opacity-30">
                <a href="#" id="logoutButton" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-red-200 hover:text-red-100 hover:bg-red-500 hover:bg-opacity-20">
                    <i class="fas fa-sign-out-alt w-5 mr-3"></i>
                    <span class="font-medium">Logout</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="bg-white shadow-sm px-8 py-5 flex items-center justify-between sticky top-0 z-50">
            <div>
                <div id="breadcrumbs" class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
                    <a href="notes.html" class="hover:text-blue-600">Notes</a>
                </div>
                <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Note Editor</h1>
            </div>
            <div class="flex items-center space-x-3">
                <button id="togglePinBtn" class="px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                    <i class="fas fa-thumbtack mr-2"></i><span id="pinText">Pin</span>
                </button>
                <button id="toggleFavoriteBtn" class="px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                    <i class="fas fa-heart mr-2"></i><span id="favoriteText">Favorite</span>
                </button>
                <button id="saveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
            </div>
        </header>
        
        <!-- Editor Area -->
        <div class="bg-white">
            <div class="editor-container">
                <!-- Editor Pane -->
                <div class="editor-pane">
                    <input 
                        type="text" 
                        id="noteTitleInput"
                        placeholder="Note title..."
                        class="w-full px-8 py-4 text-3xl font-bold border-b border-gray-200 focus:outline-none focus:border-blue-500"
                    >
                    <!-- Attachments Section -->
                    <div id="attachmentsSection" class="px-8 py-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-gray-700">Attachments</h3>
                            <label class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 cursor-pointer transition-colors">
                                <i class="fas fa-paperclip mr-1"></i>Add File
                                <input type="file" id="fileInput" class="hidden" multiple>
                            </label>
                        </div>
                        <div id="attachmentsList" class="space-y-2">
                            <!-- Attachments will be displayed here -->
                        </div>
                    </div>
                    <textarea 
                        id="noteContentInput"
                        class="markdown-editor"
                        placeholder="# Start writing your note...

Use **Markdown** to format your text:

- **Bold** text
- *Italic* text
- Headings with #
- Code blocks
- Lists
- And more!"
                    ></textarea>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let note = null;
        let course = null;
        let semester = null;
        let isPinned = false;
        let isFavorite = false;
        let hasUnsavedChanges = false;
        let autoSaveTimeout = null;
        
        // Check authentication
        if (!window.auth.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // Get note ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const noteId = urlParams.get('id');
        
        if (!noteId) {
            window.location.href = 'notes.html';
        }
        
        // Load note
        async function loadNote() {
            try {
                const response = await window.api.getNote(noteId);
                note = response.data || response.note || response;
                
                if (!note) {
                    alert('Note not found');
                    window.location.href = 'notes.html';
                    return;
                }
                
                // Find course and semester
                const semestersResponse = await window.api.getSemesters();
                const semesters = semestersResponse.data || semestersResponse.semesters || semestersResponse || [];
                
                for (const sem of semesters) {
                    try {
                        const coursesResponse = await window.api.getCourses(sem.id);
                        const courses = coursesResponse.data || coursesResponse.courses || coursesResponse || [];
                        const foundCourse = courses.find(c => c.id === note.course_id);
                        
                        if (foundCourse) {
                            course = foundCourse;
                            semester = sem;
                            break;
                        }
                    } catch (error) {
                        console.error(`Error loading courses for semester ${sem.id}:`, error);
                    }
                }
                
                // Update UI
                displayNote();
            } catch (error) {
                console.error('Error loading note:', error);
                alert('Failed to load note');
                window.location.href = 'notes.html';
            }
        }
        
        // Display note
        function displayNote() {
            document.getElementById('noteTitleInput').value = note.title || '';
            document.getElementById('noteContentInput').value = note.content || '';
            document.getElementById('pageTitle').textContent = note.title || 'Untitled Note';
            
            isPinned = note.is_pinned || false;
            isFavorite = note.is_favorite || false;
            
            // Load attachments
            if (note.attachments && Array.isArray(note.attachments)) {
                console.log('Loading attachments from note:', note.attachments);
                
                // Handle both cases: array of IDs or array of objects
                uploadedAttachments = note.attachments.map(att => {
                    // If attachment is a primitive (number/string), it's just an ID
                    if (typeof att === 'number' || typeof att === 'string') {
                        return { id: parseInt(att) };
                    }
                    // If it's an object, extract the ID
                    const id = att.id || att.attachment_id || att.attachmentId || att.file_attachment_id || att;
                    return { ...att, id: parseInt(id) };
                });
                
                attachments = uploadedAttachments.map(att => att.id).filter(id => id);
                console.log('Loaded attachments:', uploadedAttachments);
                console.log('Attachment IDs:', attachments);
                
                displayAttachments();
            } else {
                uploadedAttachments = [];
                attachments = [];
                displayAttachments();
            }
            
            updatePinButton();
            updateFavoriteButton();
            
            // Update breadcrumbs
            if (course && semester) {
                document.getElementById('breadcrumbs').innerHTML = `
                    <a href="notes.html" class="hover:text-blue-600">Notes</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="course.html?id=${course.id}" class="hover:text-blue-600">${course.name}</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-gray-800">${note.title}</span>
                `;
            }
        }
        
        // Display attachments
        function displayAttachments() {
            const container = document.getElementById('attachmentsList');
            
            if (uploadedAttachments.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 italic">No attachments</p>';
                return;
            }
            
            container.innerHTML = uploadedAttachments.map((att, index) => {
                const attachmentId = att.id;
                const isPending = att.pending && att.file;
                
                const fileName = att.file_name || att.name || att.original_name || (attachmentId ? `Attachment ${attachmentId}` : 'Unknown file');
                const fileSize = att.file_size ? formatFileSize(att.file_size) : '';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center space-x-3 flex-1">
                            <i class="fas fa-file text-blue-600"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate">${fileName}</p>
                                ${fileSize ? `<p class="text-xs text-gray-500">${fileSize}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${att.uploading ? '<span class="text-xs text-blue-600">Uploading...</span>' : ''}
                            ${isPending ? '<span class="text-xs text-yellow-600">Pending</span>' : ''}
                            ${attachmentId ? `
                                <button onclick="downloadAttachment(${attachmentId})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="removeAttachment(${attachmentId})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : `
                                <button onclick="removePendingAttachment(${index})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                // If note doesn't exist yet, store file temporarily
                if (!note || !note.id) {
                    uploadedAttachments.push({
                        file: file, // Store the actual File object
                        file_name: file.name,
                        file_size: file.size,
                        pending: true, // Mark as pending upload
                        id: null
                    });
                    displayAttachments();
                } else {
                    // Note exists, upload immediately
                    let tempId = null;
                    try {
                        // Show uploading state
                        tempId = Date.now();
                        uploadedAttachments.push({
                            id: tempId,
                            file_name: file.name,
                            file_size: file.size,
                            uploading: true
                        });
                        displayAttachments();
                        
                        // Upload file with note info (backend expects capitalized class name)
                        const response = await window.api.uploadAttachment(file, 'Note', note.id);
                        console.log('Upload response:', response);
                        
                        const attachment = response.data || response.attachment || response;
                        console.log('Attachment object:', attachment);
                        
                        // Try different possible ID field names
                        const attachmentId = attachment.id || attachment.attachment_id || attachment.attachmentId || attachment.file_attachment_id;
                        console.log('Extracted attachment ID:', attachmentId);
                        
                        // Replace temp with real attachment
                        const index = uploadedAttachments.findIndex(a => a.id === tempId);
                        if (index !== -1) {
                            uploadedAttachments[index] = attachment;
                            if (attachmentId) {
                                attachments.push(attachmentId);
                            } else {
                                console.error('Attachment missing ID:', attachment);
                            }
                        }
                        
                        displayAttachments();
                        scheduleAutoSave();
                    } catch (error) {
                        console.error('Error uploading file:', error);
                        console.error('Error details:', {
                            message: error.message,
                            status: error.status,
                            file: file.name,
                            size: file.size,
                            type: file.type
                        });
                        
                        let errorMsg = error.message || 'Unknown error';
                        if (error.status === 422) {
                            errorMsg = `Validation failed: ${error.message}. Please check file size (max 10MB) and file type.`;
                        } else if (error.status === 413) {
                            errorMsg = 'File too large. Maximum size is 10MB.';
                        }
                        
                        alert(`Failed to upload ${file.name}: ${errorMsg}`);
                        
                        // Remove failed upload
                        if (tempId !== null) {
                            uploadedAttachments = uploadedAttachments.filter(a => a.id !== tempId);
                            displayAttachments();
                        }
                    }
                }
            }
            
            // Reset input
            e.target.value = '';
        });
        
        // Download attachment
        window.downloadAttachment = async function(attachmentId) {
            if (!attachmentId || attachmentId === 'undefined') {
                alert('Invalid attachment ID');
                return;
            }
            
            try {
                const id = parseInt(attachmentId);
                if (isNaN(id)) {
                    throw new Error('Invalid attachment ID format');
                }
                console.log('Attempting to download attachment:', id, typeof id);
                await window.api.downloadAttachment(id);
            } catch (error) {
                console.error('Error downloading attachment:', error);
                console.error('Error details:', {
                    message: error.message,
                    status: error.status,
                    attachmentId: attachmentId,
                    type: typeof attachmentId
                });
                alert(`Failed to download file: ${error.message || 'Unknown error'}`);
            }
        };
        
        // Remove attachment
        window.removeAttachment = async function(attachmentId) {
            if (!attachmentId || attachmentId === 'undefined') {
                alert('Invalid attachment ID');
                return;
            }
            
            if (!confirm('Are you sure you want to remove this attachment?')) return;
            
            try {
                const id = parseInt(attachmentId);
                if (isNaN(id)) {
                    throw new Error('Invalid attachment ID format');
                }
                console.log('Attempting to delete attachment:', id, typeof id);
                await window.api.deleteAttachment(id);
                uploadedAttachments = uploadedAttachments.filter(a => {
                    const attId = a.id || a.attachment_id || a.attachmentId || a.file_attachment_id;
                    return attId != attachmentId;
                });
                attachments = attachments.filter(attId => attId != attachmentId);
                displayAttachments();
                scheduleAutoSave();
            } catch (error) {
                console.error('Error removing attachment:', error);
                console.error('Error details:', {
                    message: error.message,
                    status: error.status,
                    attachmentId: attachmentId,
                    type: typeof attachmentId
                });
                alert(`Failed to remove attachment: ${error.message || 'Unknown error'}`);
            }
        };
        
        
        // Auto-save
        function scheduleAutoSave() {
            hasUnsavedChanges = true;
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveNote(false);
            }, 2000); // Auto-save after 2 seconds of inactivity
        }
        
        // Save note
        async function saveNote(showMessage = true) {
            const title = document.getElementById('noteTitleInput').value.trim();
            const content = document.getElementById('noteContentInput').value;
            
            if (!title) {
                alert('Please enter a title');
                return;
            }
            
            const data = {
                title: title,
                content: content,
                is_pinned: isPinned,
                is_favorite: isFavorite,
                attachments: attachments, // Array of attachment IDs
            };
            
            try {
                await window.api.updateNote(noteId, data);
                
                // Upload pending attachments after saving
                const pendingFiles = uploadedAttachments.filter(att => att.pending && att.file);
                if (pendingFiles.length > 0 && note && note.id) {
                    const uploadedAttachmentIds = [];
                    
                    for (const pendingFile of pendingFiles) {
                        try {
                            const response = await window.api.uploadAttachment(pendingFile.file, 'Note', note.id);
                            const attachment = response.data || response.attachment || response;
                            const attachmentId = attachment.id || attachment.attachment_id || attachment.attachmentId || attachment.file_attachment_id;
                            
                            if (attachmentId) {
                                uploadedAttachmentIds.push(attachmentId);
                                // Replace pending file with uploaded attachment
                                const index = uploadedAttachments.findIndex(att => att === pendingFile);
                                if (index !== -1) {
                                    uploadedAttachments[index] = attachment;
                                }
                            }
                        } catch (error) {
                            console.error('Error uploading pending file:', error);
                            alert(`Failed to upload "${pendingFile.file_name || pendingFile.name}": ${error.message || 'Unknown error'}`);
                        }
                    }
                    
                    // Update note with all attachment IDs (including newly uploaded ones)
                    if (uploadedAttachmentIds.length > 0) {
                        const allAttachmentIds = [...attachments, ...uploadedAttachmentIds];
                        try {
                            await window.api.updateNote(noteId, {
                                attachments: allAttachmentIds
                            });
                            attachments = allAttachmentIds; // Update local array
                            console.log('Note updated with attachment IDs:', allAttachmentIds);
                        } catch (error) {
                            console.error('Error updating note with attachments:', error);
                            // Still add to local array even if update fails
                            attachments.push(...uploadedAttachmentIds);
                        }
                    }
                    
                    displayAttachments();
                }
                
                hasUnsavedChanges = false;
                if (showMessage) {
                    // Show temporary success indicator
                    const saveBtn = document.getElementById('saveBtn');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved!';
                    saveBtn.classList.add('bg-green-600');
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.classList.remove('bg-green-600');
                    }, 2000);
                }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note: ' + (error.message || 'Unknown error'));
            }
        }
        
        // Remove pending attachment
        window.removePendingAttachment = function(index) {
            uploadedAttachments.splice(index, 1);
            displayAttachments();
        }
        
        // Update pin button
        function updatePinButton() {
            const btn = document.getElementById('togglePinBtn');
            const text = document.getElementById('pinText');
            if (isPinned) {
                btn.classList.add('bg-yellow-50', 'border-yellow-300');
                btn.classList.remove('border-gray-300');
                text.textContent = 'Pinned';
            } else {
                btn.classList.remove('bg-yellow-50', 'border-yellow-300');
                btn.classList.add('border-gray-300');
                text.textContent = 'Pin';
            }
        }
        
        // Update favorite button
        function updateFavoriteButton() {
            const btn = document.getElementById('toggleFavoriteBtn');
            const text = document.getElementById('favoriteText');
            if (isFavorite) {
                btn.classList.add('bg-pink-50', 'border-pink-300');
                btn.classList.remove('border-gray-300');
                text.textContent = 'Favorited';
            } else {
                btn.classList.remove('bg-pink-50', 'border-pink-300');
                btn.classList.add('border-gray-300');
                text.textContent = 'Favorite';
            }
        }
        
        // Toggle pin
        document.getElementById('togglePinBtn').addEventListener('click', async () => {
            try {
                await window.api.pinNote(noteId);
                isPinned = !isPinned;
                updatePinButton();
                scheduleAutoSave();
            } catch (error) {
                console.error('Error toggling pin:', error);
            }
        });
        
        // Toggle favorite
        document.getElementById('toggleFavoriteBtn').addEventListener('click', async () => {
            try {
                await window.api.favoriteNote(noteId);
                isFavorite = !isFavorite;
                updateFavoriteButton();
                scheduleAutoSave();
            } catch (error) {
                console.error('Error toggling favorite:', error);
            }
        });
        
        // Save button
        document.getElementById('saveBtn').addEventListener('click', () => {
            saveNote(true);
        });
        
        // Title input change
        document.getElementById('noteTitleInput').addEventListener('input', () => {
            document.getElementById('pageTitle').textContent = document.getElementById('noteTitleInput').value || 'Untitled Note';
            scheduleAutoSave();
        });
        
        // Content input change
        document.getElementById('noteContentInput').addEventListener('input', () => {
            scheduleAutoSave();
        });
        
        
        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        // Handle logout
        document.getElementById('logoutButton').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await window.api.logout();
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                window.location.href = 'login.html';
            }
        });
        
        // Initialize
        loadNote();
    </script>
</body>
</html>

