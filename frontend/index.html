<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Student Tracker</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #f8fafc;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 3px solid #60a5fa;
        }
        
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }
        
        .stat-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        
        .stat-card:hover {
            border-left-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateX(4px);
        }
        
        .stat-card.blue-card {
            border-left-color: #3b82f6;
        }
        
        .stat-card.green-card {
            border-left-color: #10b981;
        }
        
        .stat-card.purple-card {
            border-left-color: #8b5cf6;
        }
        
        .stat-card.yellow-card {
            border-left-color: #f59e0b;
        }
        
        .welcome-banner {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        
        .content-card {
            transition: all 0.2s ease;
        }
        
        .content-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .section-header {
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar text-white p-6">
        <!-- Logo -->
        <div class="flex items-center mb-10">
            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center mr-3 shadow-lg">
                <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold">Student Tracker</h1>
                <p class="text-xs text-blue-200">Organize & Succeed</p>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="space-y-1">
            <a href="index.html" class="sidebar-item active flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-home w-5 mr-3"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="semesters.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-calendar-alt w-5 mr-3"></i>
                <span class="font-medium">Semesters</span>
            </a>
            <a href="courses.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-book w-5 mr-3"></i>
                <span class="font-medium">Courses</span>
            </a>
            <a href="assessments.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-clipboard-list w-5 mr-3"></i>
                <span class="font-medium">Assessments</span>
            </a>
            <a href="notes.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-sticky-note w-5 mr-3"></i>
                <span class="font-medium">Notes</span>
            </a>
            <a href="/events.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-calendar w-5 mr-3"></i>
                <span class="font-medium">Events</span>
            </a>
            <a href="/budget.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-wallet w-5 mr-3"></i>
                <span class="font-medium">Budget</span>
            </a>
            <a href="/goals.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-bullseye w-5 mr-3"></i>
                <span class="font-medium">Goals</span>
            </a>
            <a href="/tasks.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-tasks w-5 mr-3"></i>
                <span class="font-medium">Tasks</span>
            </a>
            <a href="/habits.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-chart-line w-5 mr-3"></i>
                <span class="font-medium">Habits</span>
            </a>
            <div class="pt-6 mt-6 border-t border-blue-400 border-opacity-30">
            <a href="#" id="logoutButton" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-red-200 hover:text-red-100 hover:bg-red-500 hover:bg-opacity-20">
                    <i class="fas fa-sign-out-alt w-5 mr-3"></i>
                    <span class="font-medium">Logout</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="bg-white shadow-sm px-8 py-5 flex items-center justify-between sticky top-0 z-50">
            <div class="flex-1 max-w-lg">
                <div class="relative">
                    <input 
                        id="searchInput"
                        type="text" 
                        placeholder="Search anything..." 
                        class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 text-gray-700 placeholder-gray-400"
                    >
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <!-- Search Results Dropdown -->
                    <div id="searchResults" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg border border-gray-200 max-h-96 overflow-y-auto z-50">
                        <div id="searchResultsContent" class="p-2">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-6">
                <!-- Notifications -->
                <div class="relative">
                    <button class="relative p-2.5 text-gray-600 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-50">
                        <i class="fas fa-bell text-xl"></i>
                        <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                </div>
                
                <!-- User Profile -->
                <div class="flex items-center space-x-3 pl-6 border-l border-gray-200">
                    <div class="w-11 h-11 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-semibold shadow-md" id="userAvatar">
                        <span id="userInitials" class="text-sm">U</span>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-800" id="userName">Loading...</p>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="p-8">
            <!-- Welcome Banner -->
            <div class="welcome-banner rounded-2xl p-10 mb-8 text-white shadow-lg">
                <div>
                    <p class="text-blue-100 mb-2 text-sm font-medium" id="currentDate">Loading date...</p>
                    <h1 class="text-4xl font-bold mb-2" id="welcomeMessage">Welcome back!</h1>
                    <p class="text-blue-100 text-lg">Stay organized and track your academic progress</p>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="stat-card blue-card bg-white rounded-xl p-8 shadow-sm" onclick="window.location.href='semesters.html'" style="cursor: pointer;">
                    <div class="flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-blue-50 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-alt text-blue-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mb-2 font-medium">Total Semesters</p>
                        <p class="text-4xl font-bold text-gray-800" id="semesterCount">
                            <span class="loading-skeleton inline-block w-12 h-10 bg-gray-200 rounded animate-pulse"></span>
                        </p>
                    </div>
                </div>
                
                <div class="stat-card green-card bg-white rounded-xl p-8 shadow-sm" onclick="window.location.href='courses.html'" style="cursor: pointer;">
                    <div class="flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-green-50 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book text-green-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mb-2 font-medium">Active Courses</p>
                        <p class="text-4xl font-bold text-gray-800" id="courseCount">
                            <span class="loading-skeleton inline-block w-12 h-10 bg-gray-200 rounded animate-pulse"></span>
                        </p>
                    </div>
                </div>
                
                <div class="stat-card purple-card bg-white rounded-xl p-8 shadow-sm" onclick="window.location.href='notes.html'" style="cursor: pointer;">
                    <div class="flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-purple-50 rounded-lg flex items-center justify-center">
                                <i class="fas fa-sticky-note text-purple-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mb-2 font-medium">Total Notes</p>
                        <p class="text-4xl font-bold text-gray-800" id="noteCount">0</p>
                    </div>
                </div>
                
                <div class="stat-card yellow-card bg-white rounded-xl p-8 shadow-sm" onclick="window.location.href='budget.html'" style="cursor: pointer;">
                    <div class="flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 bg-yellow-50 rounded-lg flex items-center justify-center">
                                <i class="fas fa-wallet text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mb-2 font-medium">Net Balance</p>
                        <p class="text-4xl font-bold text-gray-800" id="budgetBalance">$0</p>
                    </div>
                </div>
            </div>
            
            <!-- Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Upcoming Assessments -->
                    <div class="content-card bg-white rounded-xl p-8 shadow-sm">
                        <div class="section-header flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-800">Upcoming Assessments</h2>
                            <a href="assessments.html" class="text-sm text-blue-600 hover:text-blue-700 font-medium">See all →</a>
                        </div>
                        <div id="assessmentsList" class="space-y-4">
                            <div class="flex items-center p-5 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-file-alt text-gray-400"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">No assessments yet</p>
                                    <p class="text-sm text-gray-500 mt-1">Add courses and assessments to see them here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tasks -->
                    <div class="content-card bg-white rounded-xl p-8 shadow-sm">
                        <div class="section-header flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-800">Tasks</h2>
                            <a href="tasks.html" class="text-sm text-blue-600 hover:text-blue-700 font-medium">See all →</a>
                        </div>
                        <div id="tasksList" class="space-y-4">
                            <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                                <p class="text-gray-500 text-sm">No tasks yet. Create your first task!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="space-y-8">
                    <!-- Today's Events -->
                    <div class="content-card bg-white rounded-xl p-8 shadow-sm">
                        <div class="section-header flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-800">Today's Events</h2>
                            <a href="events.html" class="text-sm text-blue-600 hover:text-blue-700 font-medium">See all →</a>
                        </div>
                        <div id="eventsList" class="space-y-4">
                            <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                                <p class="text-gray-500 text-sm">No events scheduled for today</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Goals Progress -->
                    <div class="content-card bg-white rounded-xl p-8 shadow-sm">
                        <div class="section-header flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-800">Goals Progress</h2>
                            <a href="goals.html" class="text-sm text-blue-600 hover:text-blue-700 font-medium">See all →</a>
                        </div>
                        <div id="goalsList" class="space-y-4">
                            <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                                <p class="text-gray-500 text-sm">No goals set yet. Create your first goal!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Set current date
        function setCurrentDate() {
            const date = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = date.toLocaleDateString('en-US', options);
        }
        
        // Get user initials
        function getUserInitials(name) {
            if (!name) return 'U';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            console.log('Loading dashboard data...');
            console.log('Current URL:', window.location.href);
            
            // FIRST: Check URL for token (if coming from Google login callback)
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token') || urlParams.get('access_token') || urlParams.get('auth_token');
            const fromCallback = urlParams.get('from_callback');
            
            if (tokenFromUrl && fromCallback === '1') {
                console.log('✅ Token found in URL (from Google callback)');
                console.log('Storing token from URL...');
                
                // Store token
                localStorage.setItem('auth_token', tokenFromUrl);
                sessionStorage.setItem('auth_token', tokenFromUrl);
                window.api.setToken(tokenFromUrl);
                
                // Clean URL immediately
                window.history.replaceState({}, document.title, window.location.pathname);
                
                console.log('✅ Token stored, continuing with dashboard load...');
                // Continue loading dashboard (don't redirect to login!)
            } else {
                // Wait a bit for token to be available (in case of redirect from OAuth)
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Check authentication
                if (!window.auth.isAuthenticated()) {
                    console.log('❌ Not authenticated, redirecting to login');
                    console.log('Token check:', window.api.getToken());
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('✅ Authentication check passed');
                console.log('Token exists:', !!window.api.getToken());
            }
            
            // Set default values immediately
            document.getElementById('userName').textContent = 'Loading...';
            document.getElementById('userInitials').textContent = 'U';
            
            try {
                // Load user info
                console.log('Attempting to load user info...');
                const response = await window.api.getCurrentUser();
                console.log('✅ Full API response:', JSON.stringify(response, null, 2));
                
                // Handle different response structures
                // Could be: { name, email }, { user: { name, email } }, { data: { name, email } }, { data: { user: { name, email } } }
                let user = response;
                if (response.data && response.data.user) {
                    // Structure: { data: { user: { name, email } } }
                    user = response.data.user;
                } else if (response.data) {
                    // Structure: { data: { name, email } }
                    user = response.data;
                } else if (response.user) {
                    // Structure: { user: { name, email } }
                    user = response.user;
                }
                
                console.log('Extracted user object:', user);
                console.log('User name:', user.name);
                console.log('User email:', user.email);
                
                // Update user info - prioritize name, then email
                let displayName = 'User';
                if (user && user.name) {
                    displayName = user.name;
                } else if (user && user.email) {
                    displayName = user.email;
                }
                
                console.log('Final display name:', displayName);
                document.getElementById('userName').textContent = displayName;
                
                // Get initials from name or email
                const nameForInitials = (user && user.name) || (user && user.email) || '';
                document.getElementById('userInitials').textContent = getUserInitials(nameForInitials);
                
                // Update welcome message
                const welcomeMsg = document.getElementById('welcomeMessage');
                if (user && user.name) {
                    const firstName = user.name.split(' ')[0];
                    welcomeMsg.textContent = `Welcome back, ${firstName}!`;
                } else if (user && user.email) {
                    const emailName = user.email.split('@')[0];
                    welcomeMsg.textContent = `Welcome back, ${emailName}!`;
                }
                
                // Load actual data from API
                await loadDashboardStats();
                await loadUpcomingAssessments();
                await loadTasks();
                await loadGoalsProgress();
                await loadTodaysEvents();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                console.error('Error status:', error.status);
                console.error('Error message:', error.message);
                
                // Only redirect if it's an authentication error (401/403)
                if (error.status === 401 || error.status === 403 || 
                    (error.message && (error.message.includes('401') || error.message.includes('403') || error.message.includes('Unauthorized')))) {
                    console.log('Authentication failed, redirecting to login');
                    window.api.removeToken();
                    window.location.href = 'login.html';
                    return;
                }
                
                // For other errors, show default user info but stay on page
                console.warn('Non-auth error, staying on page. Error:', error.message);
                document.getElementById('userName').textContent = 'Loading...';
                document.getElementById('userInitials').textContent = 'U';
                
                // Show error message to user
                const welcomeMsg = document.getElementById('welcomeMessage');
                welcomeMsg.textContent = 'Welcome!';
            }
        }
        
        // Handle logout
        document.getElementById('logoutButton').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await window.api.logout();
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                window.location.href = 'login.html';
            }
        });
        
        // Search functionality
        let searchTimeout;
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchResultsContent = document.getElementById('searchResultsContent');
        
        if (searchInput && searchResults && searchResultsContent) {
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                // Debounce search
                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }
        
        // Perform search across all entities
        async function performSearch(query) {
            try {
                searchResultsContent.innerHTML = '<div class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
                searchResults.classList.remove('hidden');
                
                const results = {
                    courses: [],
                    notes: [],
                    assessments: [],
                    goals: [],
                    tasks: [],
                    habits: [],
                    events: []
                };
                
                // Search notes
                try {
                    const notesResponse = await window.api.searchNotes(query);
                    if (notesResponse.success) {
                        results.notes = notesResponse.data || [];
                    }
                } catch (error) {
                    console.error('Error searching notes via API:', error);
                }
                
                // Fallback: If API search returns few/no results, also search locally
                // This ensures we can search by title even if backend search has issues
                if (results.notes.length === 0) {
                    try {
                        // Get all notes from all courses and search locally
                        const semestersResponse = await window.api.getSemesters();
                        const semesters = semestersResponse.data || semestersResponse.semesters || semestersResponse || [];
                        
                        for (const semester of semesters) {
                            try {
                                const coursesResponse = await window.api.getCourses(semester.id);
                                const courses = coursesResponse.data || coursesResponse.courses || coursesResponse || [];
                                
                                for (const course of courses) {
                                    try {
                                        const notesResponse = await window.api.getNotes(course.id);
                                        const notes = notesResponse.data || notesResponse.notes || notesResponse || [];
                                        
                                        for (const note of notes) {
                                            const noteMatch = note.title.toLowerCase().includes(query.toLowerCase()) ||
                                                            (note.content && note.content.toLowerCase().includes(query.toLowerCase()));
                                            if (noteMatch) {
                                                // Avoid duplicates
                                                if (!results.notes.find(n => n.id === note.id)) {
                                                    results.notes.push({
                                                        ...note,
                                                        course_name: course.name,
                                                        course_code: course.code
                                                    });
                                                }
                                            }
                                        }
                                    } catch (error) {
                                        console.error(`Error loading notes for course ${course.id}:`, error);
                                    }
                                }
                            } catch (error) {
                                console.error(`Error loading courses for semester ${semester.id}:`, error);
                            }
                        }
                    } catch (error) {
                        console.error('Error in fallback notes search:', error);
                    }
                }
                
                // Search courses and assessments
                try {
                    const semestersResponse = await window.api.getSemesters();
                    const semesters = semestersResponse.data || semestersResponse.semesters || semestersResponse || [];
                    
                    for (const semester of semesters) {
                        try {
                            const coursesResponse = await window.api.getCourses(semester.id);
                            const courses = coursesResponse.data || coursesResponse.courses || coursesResponse || [];
                            
                            for (const course of courses) {
                                // Check if course matches search
                                const courseMatch = course.name.toLowerCase().includes(query.toLowerCase()) ||
                                                  course.code.toLowerCase().includes(query.toLowerCase()) ||
                                                  (course.description && course.description.toLowerCase().includes(query.toLowerCase()));
                                
                                if (courseMatch) {
                                    results.courses.push({
                                        ...course,
                                        semester_title: semester.title
                                    });
                                }
                                
                                // Search assessments in this course
                                try {
                                    const assessmentsResponse = await window.api.getAssessments(course.id);
                                    const assessments = assessmentsResponse.data || assessmentsResponse.assessments || assessmentsResponse || [];
                                    
                                    for (const assessment of assessments) {
                                        // Skip submitted assessments
                                        const status = (assessment.status || 'not_started').toLowerCase();
                                        if (status === 'submitted') {
                                            continue;
                                        }
                                        
                                        const assessmentMatch = assessment.title.toLowerCase().includes(query.toLowerCase()) ||
                                                               (assessment.description && assessment.description.toLowerCase().includes(query.toLowerCase()));
                                        
                                        if (assessmentMatch) {
                                            results.assessments.push({
                                                ...assessment,
                                                course_name: course.name,
                                                course_code: course.code,
                                                semester_title: semester.title
                                            });
                                        }
                                    }
                                } catch (error) {
                                    console.error(`Error loading assessments for course ${course.id}:`, error);
                                }
                            }
                        } catch (error) {
                            console.error(`Error loading courses for semester ${semester.id}:`, error);
                        }
                    }
                } catch (error) {
                    console.error('Error searching courses/assessments:', error);
                }
                
                // Search goals
                try {
                    const goalsResponse = await window.api.getGoals();
                    if (goalsResponse.success) {
                        const goals = goalsResponse.data || [];
                        for (const goal of goals) {
                            const goalMatch = goal.title.toLowerCase().includes(query.toLowerCase()) ||
                                            (goal.description && goal.description.toLowerCase().includes(query.toLowerCase()));
                            if (goalMatch) {
                                results.goals.push(goal);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error searching goals:', error);
                }
                
                // Search tasks
                try {
                    const tasksResponse = await window.api.getTasks();
                    if (tasksResponse.success) {
                        const tasks = tasksResponse.data || [];
                        for (const task of tasks) {
                            const taskMatch = task.title.toLowerCase().includes(query.toLowerCase()) ||
                                            (task.description && task.description.toLowerCase().includes(query.toLowerCase()));
                            if (taskMatch) {
                                results.tasks.push(task);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error searching tasks:', error);
                }
                
                // Search habits
                try {
                    const habitsResponse = await window.api.getHabits();
                    if (habitsResponse.success) {
                        const habits = habitsResponse.data || [];
                        for (const habit of habits) {
                            const habitMatch = habit.name.toLowerCase().includes(query.toLowerCase());
                            if (habitMatch) {
                                results.habits.push(habit);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error searching habits:', error);
                }
                
                // Search events
                try {
                    const eventsResponse = await window.api.getEvents();
                    if (eventsResponse.success) {
                        const events = eventsResponse.data || [];
                        for (const event of events) {
                            const eventMatch = event.title.toLowerCase().includes(query.toLowerCase()) ||
                                             (event.description && event.description.toLowerCase().includes(query.toLowerCase())) ||
                                             (event.location && event.location.toLowerCase().includes(query.toLowerCase()));
                            if (eventMatch) {
                                results.events.push(event);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error searching events:', error);
                }
                
                // Display results
                displaySearchResults(results, query);
                
            } catch (error) {
                console.error('Error performing search:', error);
                searchResultsContent.innerHTML = '<div class="p-4 text-center text-red-500">Error performing search</div>';
            }
        }
        
        // Display search results
        function displaySearchResults(results, query) {
            const totalResults = results.courses.length + results.notes.length + results.assessments.length + 
                                results.goals.length + results.tasks.length + results.habits.length + results.events.length;
            
            if (totalResults === 0) {
                searchResultsContent.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>No results found for "${query}"</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Courses
            if (results.courses.length > 0) {
                html += '<div class="mb-2"><p class="text-xs font-semibold text-gray-500 uppercase px-3 py-2">Courses</p>';
                results.courses.slice(0, 5).forEach(course => {
                    html += `
                        <a href="course.html?id=${course.id}" class="block px-3 py-2 hover:bg-gray-50 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-book text-blue-600"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${escapeHtml(course.name)}</p>
                                    <p class="text-xs text-gray-500">${escapeHtml(course.code)} • ${escapeHtml(course.semester_title || '')}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                if (results.courses.length > 5) {
                    html += `<p class="text-xs text-gray-500 px-3 py-1">+${results.courses.length - 5} more courses</p>`;
                }
                html += '</div>';
            }
            
            // Notes
            if (results.notes.length > 0) {
                html += '<div class="mb-2"><p class="text-xs font-semibold text-gray-500 uppercase px-3 py-2">Notes</p>';
                results.notes.slice(0, 5).forEach(note => {
                    html += `
                        <a href="note.html?id=${note.id}" class="block px-3 py-2 hover:bg-gray-50 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-sticky-note text-purple-600"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${escapeHtml(note.title)}</p>
                                    <p class="text-xs text-gray-500 line-clamp-1">${escapeHtml(note.content?.substring(0, 50) || '')}...</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                if (results.notes.length > 5) {
                    html += `<p class="text-xs text-gray-500 px-3 py-1">+${results.notes.length - 5} more notes</p>`;
                }
                html += '</div>';
            }
            
            // Assessments
            if (results.assessments.length > 0) {
                html += '<div class="mb-2"><p class="text-xs font-semibold text-gray-500 uppercase px-3 py-2">Assessments</p>';
                results.assessments.slice(0, 5).forEach(assessment => {
                    html += `
                        <a href="assessments.html" class="block px-3 py-2 hover:bg-gray-50 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-clipboard-list text-orange-600"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${escapeHtml(assessment.title)}</p>
                                    <p class="text-xs text-gray-500">${escapeHtml(assessment.course_name)} • ${formatDate(assessment.due_date)}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                if (results.assessments.length > 5) {
                    html += `<p class="text-xs text-gray-500 px-3 py-1">+${results.assessments.length - 5} more assessments</p>`;
                }
                html += '</div>';
            }
            
            // Goals
            if (results.goals.length > 0) {
                html += '<div class="mb-2"><p class="text-xs font-semibold text-gray-500 uppercase px-3 py-2">Goals</p>';
                results.goals.slice(0, 5).forEach(goal => {
                    html += `
                        <a href="goals.html" class="block px-3 py-2 hover:bg-gray-50 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-bullseye text-green-600"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${escapeHtml(goal.title)}</p>
                                    <p class="text-xs text-gray-500 line-clamp-1">${escapeHtml(goal.description?.substring(0, 50) || '')}${goal.description && goal.description.length > 50 ? '...' : ''}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                if (results.goals.length > 5) {
                    html += `<p class="text-xs text-gray-500 px-3 py-1">+${results.goals.length - 5} more goals</p>`;
                }
                html += '</div>';
            }
            
            // Tasks
            if (results.tasks.length > 0) {
                html += '<div class="mb-2"><p class="text-xs font-semibold text-gray-500 uppercase px-3 py-2">Tasks</p>';
                results.tasks.slice(0, 5).forEach(task => {
                    html += `
                        <a href="tasks.html" class="block px-3 py-2 hover:bg-gray-50 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-tasks text-blue-600"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${escapeHtml(task.title)}</p>
                                    <p class="text-xs text-gray-500 line-clamp-1">${escapeHtml(task.description?.substring(0, 50) || '')}${task.description && task.description.length > 50 ? '...' : ''}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                if (results.tasks.length > 5) {
                    html += `<p class="text-xs text-gray-500 px-3 py-1">+${results.tasks.length - 5} more tasks</p>`;
                }
                html += '</div>';
            }
            
            // Habits
            if (results.habits.length > 0) {
                html += '<div class="mb-2"><p class="text-xs font-semibold text-gray-500 uppercase px-3 py-2">Habits</p>';
                results.habits.slice(0, 5).forEach(habit => {
                    html += `
                        <a href="habits.html" class="block px-3 py-2 hover:bg-gray-50 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-chart-line text-indigo-600"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${escapeHtml(habit.name)}</p>
                                    <p class="text-xs text-gray-500">${escapeHtml(habit.frequency_type)} • Target: ${habit.target_count}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                if (results.habits.length > 5) {
                    html += `<p class="text-xs text-gray-500 px-3 py-1">+${results.habits.length - 5} more habits</p>`;
                }
                html += '</div>';
            }
            
            // Events
            if (results.events.length > 0) {
                html += '<div class="mb-2"><p class="text-xs font-semibold text-gray-500 uppercase px-3 py-2">Events</p>';
                results.events.slice(0, 5).forEach(event => {
                    html += `
                        <a href="events.html" class="block px-3 py-2 hover:bg-gray-50 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-calendar text-red-600"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${escapeHtml(event.title)}</p>
                                    <p class="text-xs text-gray-500">${formatDate(event.date)}${event.location ? ' • ' + escapeHtml(event.location) : ''}</p>
                                </div>
                            </div>
                        </a>
                    `;
                });
                if (results.events.length > 5) {
                    html += `<p class="text-xs text-gray-500 px-3 py-1">+${results.events.length - 5} more events</p>`;
                }
                html += '</div>';
            }
            
            searchResultsContent.innerHTML = html;
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                // Load semesters count
                const semestersResponse = await window.api.getSemesters();
                const semesters = semestersResponse.data || semestersResponse.semesters || semestersResponse || [];
                document.getElementById('semesterCount').innerHTML = semesters.length;
                
                // Load courses count (from all semesters)
                let totalCourses = 0;
                for (const semester of semesters) {
                    try {
                        const coursesResponse = await window.api.getCourses(semester.id);
                        const courses = coursesResponse.data || coursesResponse.courses || coursesResponse || [];
                        totalCourses += courses.length;
                    } catch (error) {
                        console.error(`Error loading courses for semester ${semester.id}:`, error);
                    }
                }
                document.getElementById('courseCount').innerHTML = totalCourses;
                
                // Load budget balance
                await loadBudgetBalance();
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Show error state
                document.getElementById('semesterCount').innerHTML = '-';
                document.getElementById('courseCount').innerHTML = '-';
            }
        }
        
        // Load budget balance
        async function loadBudgetBalance() {
            try {
                // Get transaction summary from API (database)
                const summaryResponse = await window.api.getTransactionSummary({});
                
                if (summaryResponse.success && summaryResponse.data) {
                    // Get net_balance directly from API response, or calculate if not provided
                    const netBalance = summaryResponse.data.net_balance !== undefined 
                        ? parseFloat(summaryResponse.data.net_balance)
                        : parseFloat(summaryResponse.data.total_income || summaryResponse.data.income || 0) - 
                          parseFloat(summaryResponse.data.total_expenses || summaryResponse.data.expenses || 0);
                    
                    // Format and display
                    const formattedBalance = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(netBalance);
                    
                    document.getElementById('budgetBalance').textContent = formattedBalance;
                } else {
                    document.getElementById('budgetBalance').textContent = '$0';
                }
            } catch (error) {
                console.error('Error loading budget balance:', error);
                document.getElementById('budgetBalance').textContent = '$0';
            }
        }
        
        // Load upcoming assessments
        async function loadUpcomingAssessments() {
            try {
                // Get all semesters
                const semestersResponse = await window.api.getSemesters();
                const semesters = semestersResponse.data || semestersResponse.semesters || semestersResponse || [];
                
                // Get all courses and their assessments
                let allAssessments = [];
                for (const semester of semesters) {
                    try {
                        const coursesResponse = await window.api.getCourses(semester.id);
                        const courses = coursesResponse.data || coursesResponse.courses || coursesResponse || [];
                        
                        for (const course of courses) {
                            try {
                                const assessmentsResponse = await window.api.getAssessments(course.id);
                                const assessments = assessmentsResponse.data || assessmentsResponse.assessments || assessmentsResponse || [];
                                
                                assessments.forEach(assessment => {
                                    assessment.course_name = course.name;
                                    assessment.course_code = course.code;
                                    assessment.semester_title = semester.title;
                                    allAssessments.push(assessment);
                                });
                            } catch (error) {
                                console.error(`Error loading assessments for course ${course.id}:`, error);
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading courses for semester ${semester.id}:`, error);
                    }
                }
                
                // Filter out submitted assessments
                allAssessments = allAssessments.filter(assessment => {
                    const status = (assessment.status || 'not_started').toLowerCase();
                    return status !== 'submitted';
                });
                
                // Sort by due date (upcoming first)
                allAssessments.sort((a, b) => {
                    if (!a.due_date) return 1;
                    if (!b.due_date) return -1;
                    return new Date(a.due_date) - new Date(b.due_date);
                });
                
                // Show top 5 upcoming assessments
                const upcoming = allAssessments.slice(0, 5);
                displayUpcomingAssessments(upcoming);
            } catch (error) {
                console.error('Error loading upcoming assessments:', error);
            }
        }
        
        // Get status badge for dashboard
        function getStatusBadgeDashboard(status) {
            const statusConfig = {
                'not_started': { color: 'bg-gray-100 text-gray-700', text: 'Not Started', icon: 'fa-circle' },
                'in_progress': { color: 'bg-blue-100 text-blue-700', text: 'In Progress', icon: 'fa-spinner' },
                'completed': { color: 'bg-green-100 text-green-700', text: 'Completed', icon: 'fa-check-circle' },
                'submitted': { color: 'bg-orange-100 text-orange-700', text: 'Submitted', icon: 'fa-paper-plane' },
                'graded': { color: 'bg-purple-100 text-purple-700', text: 'Graded', icon: 'fa-star' },
            };
            return statusConfig[status] || statusConfig['not_started'];
        }
        
        // Display upcoming assessments
        function displayUpcomingAssessments(assessments) {
            const container = document.getElementById('assessmentsList');
            
            if (assessments.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-alt text-gray-400"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">No assessments yet</p>
                                <p class="text-sm text-gray-500">Add courses and assessments to see them here</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Build assessments HTML
            const assessmentsHTML = assessments.map(assessment => {
                const dueDate = assessment.due_date ? new Date(assessment.due_date).toLocaleDateString() : 'No due date';
                const isOverdue = assessment.due_date && new Date(assessment.due_date) < new Date();
                const daysUntil = assessment.due_date ? Math.ceil((new Date(assessment.due_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                const status = assessment.status || 'not_started';
                const statusBadge = getStatusBadgeDashboard(status);
                
                let dateBadge = '';
                if (daysUntil !== null) {
                    if (isOverdue) {
                        dateBadge = '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">Overdue</span>';
                    } else if (daysUntil === 0) {
                        dateBadge = '<span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">Today</span>';
                    } else if (daysUntil <= 7) {
                        dateBadge = `<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">${daysUntil} days</span>`;
                    }
                }
                
                const typeColors = {
                    quiz: 'bg-blue-100 text-blue-700',
                    midterm: 'bg-orange-100 text-orange-700',
                    final: 'bg-red-100 text-red-700',
                    assignment: 'bg-green-100 text-green-700',
                    project: 'bg-purple-100 text-purple-700',
                };
                const typeColor = typeColors[assessment.type] || 'bg-gray-100 text-gray-700';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="w-12 h-12 ${typeColor} rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <p class="font-semibold text-gray-800">${assessment.title}</p>
                                    <span class="text-xs ${statusBadge.color} px-2 py-0.5 rounded">
                                        <i class="fas ${statusBadge.icon} mr-1"></i>${statusBadge.text}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500">
                                    ${assessment.course_name}${assessment.course_code ? ` (${assessment.course_code})` : ''}
                                    ${assessment.semester_title ? ` • ${assessment.semester_title}` : ''}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${dateBadge}
                            <span class="text-sm text-gray-500">${dueDate}</span>
                            <a href="course.html?id=${assessment.course_id}" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = assessmentsHTML;
        }
        
        // Load tasks
        async function loadTasks() {
            try {
                // Show loading state
                const container = document.getElementById('tasksList');
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">Loading tasks...</p>
                    </div>
                `;
                
                // Load both tasks and goals in parallel
                const [tasksResponse, goalsResponse] = await Promise.all([
                    window.api.getTasks(),
                    window.api.getGoals()
                ]);
                
                if (tasksResponse.success) {
                    const allTasks = tasksResponse.data || [];
                    const goals = goalsResponse.success ? (goalsResponse.data || []) : [];
                    
                    // Create a goals map for quick lookup
                    const goalsMap = {};
                    goals.forEach(goal => {
                        goalsMap[goal.id] = goal;
                    });
                    
                    // Filter out completed tasks (tasks use 'completed' boolean, not 'status')
                    // Handle cases where completed might be null, undefined, false, true, or string
                    const activeTasks = allTasks.filter(task => {
                        // Check if task is completed - handle boolean, string, or number
                        const isCompleted = task.completed === true || 
                                          task.completed === 'true' || 
                                          task.completed === 1 || 
                                          task.completed === '1';
                        // Only show tasks that are NOT completed
                        return !isCompleted;
                    });
                    
                    console.log('Total tasks:', allTasks.length, 'Active tasks:', activeTasks.length);
                    
                    // Add goal title to each task
                    activeTasks.forEach(task => {
                        if (task.goal_id && goalsMap[task.goal_id]) {
                            task.goal_title = goalsMap[task.goal_id].title;
                        }
                    });
                    
                    // Sort by due date (upcoming first, then no due date)
                    activeTasks.sort((a, b) => {
                        if (!a.due_date && !b.due_date) return 0;
                        if (!a.due_date) return 1;
                        if (!b.due_date) return -1;
                        return new Date(a.due_date) - new Date(b.due_date);
                    });
                    
                    // Show top 5 tasks
                    const tasks = activeTasks.slice(0, 5);
                    displayTasks(tasks);
                } else {
                    throw new Error('Failed to load tasks');
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                // Show error state
                const container = document.getElementById('tasksList');
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">Failed to load tasks. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Display tasks
        function displayTasks(tasks) {
            const container = document.getElementById('tasksList');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">No tasks yet. Create your first task!</p>
                    </div>
                `;
                return;
            }
            
            // Build tasks HTML
            const tasksHTML = tasks.map(task => {
                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString() : null;
                const isOverdue = task.due_date && !task.completed && new Date(task.due_date) < new Date();
                // Tasks use 'completed' boolean, determine status from that
                const isCompleted = task.completed || false;
                const status = isCompleted ? 'completed' : (task.status || 'pending');
                const statusColors = {
                    'pending': 'bg-gray-100 text-gray-700',
                    'in_progress': 'bg-blue-100 text-blue-700',
                    'completed': 'bg-green-100 text-green-700'
                };
                const statusLabels = {
                    'pending': 'Pending',
                    'in_progress': 'In Progress',
                    'completed': 'Completed'
                };
                
                return `
                    <div class="p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow cursor-pointer" onclick="window.location.href='tasks.html'">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-semibold text-gray-800 ${isCompleted ? 'line-through text-gray-500' : ''}">${escapeHtml(task.title || 'Untitled Task')}</h4>
                                    ${!isCompleted ? `<span class="text-xs ${statusColors[status] || statusColors.pending} px-2 py-0.5 rounded">
                                        ${statusLabels[status] || 'Pending'}
                                    </span>` : ''}
                                </div>
                                ${task.description ? `<p class="text-sm text-gray-600 mb-1 line-clamp-2">${escapeHtml(task.description)}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            ${dueDate ? `<span class="${isOverdue ? 'text-red-600 font-medium' : ''}"><i class="fas fa-calendar mr-1"></i>${dueDate}</span>` : ''}
                            ${task.goal_title ? `<span><i class="fas fa-bullseye mr-1"></i>${escapeHtml(task.goal_title)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = tasksHTML;
        }
        
        // Load goals progress
        async function loadGoalsProgress() {
            const container = document.getElementById('goalsList');
            try {
                // Show loading state
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">Loading goals...</p>
                    </div>
                `;
                
                const response = await window.api.getGoals();
                const goals = response.data || response.goals || response || [];
                
                displayGoalsProgress(goals);
            } catch (error) {
                console.error('Error loading goals:', error);
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">No goals set yet. Create your first goal!</p>
                    </div>
                `;
            }
        }
        
        // Display goals progress
        function displayGoalsProgress(goals) {
            const container = document.getElementById('goalsList');
            
            if (!goals || goals.length === 0) {
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">No goals set yet. Create your first goal!</p>
                    </div>
                `;
                return;
            }
            
            // Sort by progress (show in-progress goals first) and limit to 5
            const sortedGoals = [...goals].sort((a, b) => {
                // Prioritize in-progress over completed/not started
                const getStatusPriority = (goal) => {
                    const progress = goal.progress || 0;
                    if (progress > 0 && progress < 100) return 0; // In progress
                    if (progress === 0) return 1; // Not started
                    return 2; // Completed
                };
                return getStatusPriority(a) - getStatusPriority(b);
            }).slice(0, 5);
            
            const goalsHTML = sortedGoals.map(goal => {
                const progress = goal.progress || 0;
                const targetDate = goal.target_date ? new Date(goal.target_date).toLocaleDateString() : null;
                const isOverdue = goal.target_date && new Date(goal.target_date) < new Date() && progress < 100;
                const isCompleted = progress >= 100;
                
                // Determine progress bar color
                let progressColor = 'bg-blue-500';
                if (isCompleted) {
                    progressColor = 'bg-green-500';
                } else if (isOverdue) {
                    progressColor = 'bg-red-500';
                } else if (progress >= 75) {
                    progressColor = 'bg-green-500';
                } else if (progress >= 50) {
                    progressColor = 'bg-yellow-500';
                }
                
                // Status badge
                let statusBadge = '';
                if (isCompleted) {
                    statusBadge = '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full"><i class="fas fa-check mr-1"></i>Done</span>';
                } else if (isOverdue) {
                    statusBadge = '<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full"><i class="fas fa-exclamation mr-1"></i>Overdue</span>';
                }
                
                return `
                    <div class="p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow cursor-pointer" onclick="window.location.href='goals.html'">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-semibold text-gray-800">${goal.title || 'Untitled Goal'}</h4>
                                    ${statusBadge}
                                </div>
                                ${goal.description ? `<p class="text-xs text-gray-500 line-clamp-1">${goal.description}</p>` : ''}
                            </div>
                            <span class="text-sm font-bold ${isCompleted ? 'text-green-600' : isOverdue ? 'text-red-600' : 'text-blue-600'}">${Math.round(progress)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div class="${progressColor} h-2 rounded-full transition-all duration-300" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        ${targetDate ? `<p class="text-xs text-gray-400"><i class="fas fa-calendar mr-1"></i>Target: ${targetDate}</p>` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = goalsHTML;
        }
        
        // Load today's events
        async function loadTodaysEvents() {
            const container = document.getElementById('eventsList');
            try {
                // Show loading state
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">Loading events...</p>
                    </div>
                `;
                
                const today = new Date().toISOString().split('T')[0];
                const response = await window.api.getEvents({ start_date: today, end_date: today });
                const events = response.data || response.events || response || [];
                
                displayTodaysEvents(events);
            } catch (error) {
                console.error('Error loading events:', error);
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">No events scheduled for today</p>
                    </div>
                `;
            }
        }
        
        // Display today's events
        function displayTodaysEvents(events) {
            const container = document.getElementById('eventsList');
            
            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-gray-200">
                        <p class="text-gray-500 text-sm">No events scheduled for today</p>
                    </div>
                `;
                return;
            }
            
            // Sort by time
            const sortedEvents = [...events].sort((a, b) => {
                const timeA = a.time || a.start_time || '00:00';
                const timeB = b.time || b.start_time || '00:00';
                return timeA.localeCompare(timeB);
            }).slice(0, 5);
            
            const eventsHTML = sortedEvents.map(event => {
                const title = event.title || event.name || 'Event';
                const time = event.time || event.start_time || null;
                const location = event.location || null;
                const link = event.google_event_link || event.link || null;
                
                return `
                    <div class="p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow cursor-pointer" onclick="window.location.href='events.html'">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600 flex-shrink-0">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-gray-800 mb-1">${title}</h4>
                                <div class="flex flex-wrap gap-2 text-xs text-gray-500">
                                    ${time ? `<span><i class="fas fa-clock mr-1"></i>${time}</span>` : ''}
                                    ${location ? `<span><i class="fas fa-map-marker-alt mr-1"></i>${location}</span>` : ''}
                                </div>
                                ${link ? `<a href="${link}" target="_blank" onclick="event.stopPropagation()" class="text-xs text-emerald-600 hover:text-emerald-700 mt-1 inline-block"><i class="fab fa-google mr-1"></i>View in Google</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = eventsHTML;
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            setCurrentDate();
            loadDashboardData();
        });
    </script>
</body>
</html>
