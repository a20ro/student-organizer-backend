<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget - Student Tracker</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #f8fafc;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 3px solid #60a5fa;
        }
        
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }
        
        .stat-card {
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .transaction-item {
            transition: all 0.2s ease;
        }
        
        .transaction-item:hover {
            background: #f9fafb;
            border-left-color: #3b82f6;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar text-white p-6">
        <!-- Logo -->
        <div class="flex items-center mb-10">
            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center mr-3 shadow-lg">
                <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold">Student Tracker</h1>
                <p class="text-xs text-blue-200">Organize & Succeed</p>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="space-y-1">
            <a href="index.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-home w-5 mr-3"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="semesters.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-calendar-alt w-5 mr-3"></i>
                <span class="font-medium">Semesters</span>
            </a>
            <a href="courses.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-book w-5 mr-3"></i>
                <span class="font-medium">Courses</span>
            </a>
            <a href="assessments.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-clipboard-list w-5 mr-3"></i>
                <span class="font-medium">Assessments</span>
            </a>
            <a href="notes.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-sticky-note w-5 mr-3"></i>
                <span class="font-medium">Notes</span>
            </a>
            <a href="/events.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-calendar w-5 mr-3"></i>
                <span class="font-medium">Events</span>
            </a>
            <a href="/budget.html" class="sidebar-item active flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-wallet w-5 mr-3"></i>
                <span class="font-medium">Budget</span>
            </a>
            <a href="/goals.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-bullseye w-5 mr-3"></i>
                <span class="font-medium">Goals</span>
            </a>
            <a href="/tasks.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-tasks w-5 mr-3"></i>
                <span class="font-medium">Tasks</span>
            </a>
            <a href="/habits.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg">
                <i class="fas fa-chart-line w-5 mr-3"></i>
                <span class="font-medium">Habits</span>
            </a>
            <div class="pt-6 mt-6 border-t border-blue-400 border-opacity-30">
                <a href="#" id="logoutButton" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-red-200 hover:text-red-100 hover:bg-red-500 hover:bg-opacity-20">
                    <i class="fas fa-sign-out-alt w-5 mr-3"></i>
                    <span class="font-medium">Logout</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="bg-white shadow-sm px-8 py-5 flex items-center justify-between sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Budget Management</h1>
                    <p class="text-sm text-gray-500 mt-1" id="selectedMonthDisplay">Track your income and expenses</p>
                </div>
                <!-- Month Navigation -->
                <div class="flex items-center gap-2 ml-6">
                    <button id="prevMonthBtn" class="p-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg">
                        <span id="currentMonthDisplay" class="text-sm font-semibold text-gray-800"></span>
                    </div>
                    <button id="nextMonthBtn" class="p-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <button id="addTransactionBtn" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Add Transaction</span>
            </button>
        </header>
        
        <!-- Content -->
        <div class="p-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-green-100 text-sm font-medium">Total Income</p>
                        <i class="fas fa-arrow-up text-2xl opacity-80"></i>
                    </div>
                    <p id="totalIncome" class="text-3xl font-bold">$0.00</p>
                </div>
                
                <div class="stat-card bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-red-100 text-sm font-medium">Total Expenses</p>
                        <i class="fas fa-arrow-down text-2xl opacity-80"></i>
                    </div>
                    <p id="totalExpenses" class="text-3xl font-bold">$0.00</p>
                </div>
                
                <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-blue-100 text-sm font-medium">Net Balance</p>
                        <i class="fas fa-wallet text-2xl opacity-80"></i>
                    </div>
                    <p id="netBalance" class="text-3xl font-bold">$0.00</p>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Spending by Category (Pie Chart) -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Spending by Category</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                
                <!-- Spending Over Time (Bar Chart) -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" id="timelineChartTitle">Spending Over Time</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Filters and Transaction List -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                    <h3 class="text-lg font-semibold text-gray-800">Transactions</h3>
                    <div class="flex flex-wrap gap-3">
                        <select id="typeFilter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Types</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                        <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Categories</option>
                        </select>
                        <button id="clearFilters" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                            <i class="fas fa-times mr-1"></i> Clear
                        </button>
                        <!-- Hidden input to store current month value -->
                        <input type="hidden" id="monthFilter" value="">
                    </div>
                </div>
                
                <!-- Transactions List -->
                <div id="transactionsList" class="space-y-2">
                    <!-- Transactions will be loaded here -->
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-12 hidden">
                    <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 font-medium">No transactions found for this month</p>
                    <p class="text-sm text-gray-400 mt-2">Add your first transaction to get started</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">Add Transaction</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="transactionForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <select id="transactionType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="transactionCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Category</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                    <input type="number" id="transactionAmount" step="0.01" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input type="date" id="transactionDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Note (Optional)</label>
                    <textarea id="transactionNote" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add a note..."></textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition">
                        <span id="submitBtnText">Add Transaction</span>
                    </button>
                    <button type="button" id="cancelBtn" class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Global variables
        let transactions = [];
        let summary = null;
        let categoryChart = null;
        let timelineChart = null;
        let editingTransactionId = null;
        
        // Expense categories
        const expenseCategories = [
            'Food',
            'Transportation',
            'Books & Supplies',
            'Entertainment',
            'Bills & Utilities',
            'Shopping',
            'Healthcare',
            'Education',
            'Other'
        ];
        
        // Income categories
        const incomeCategories = [
            'Salary',
            'Freelance',
            'Gift',
            'Scholarship',
            'Investment',
            'Allowance',
            'Other'
        ];
        
        // All categories (for filter)
        const allCategories = [...incomeCategories, ...expenseCategories];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!window.auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Set today's date as default
            document.getElementById('transactionDate').valueAsDate = new Date();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthFilter = document.getElementById('monthFilter');
            monthFilter.value = currentMonth;
            updateSelectedMonthDisplay(currentMonth);
            
            // Populate category dropdowns
            populateCategoryDropdowns();
            
            // Load data
            await loadBudgetData();
            
            // Event listeners
            document.getElementById('addTransactionBtn').addEventListener('click', () => openModal());
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('transactionForm').addEventListener('submit', handleSubmit);
            document.getElementById('transactionType').addEventListener('change', updateCategoryDropdown);
            
            // Filter event listeners
            const typeFilter = document.getElementById('typeFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            
            if (typeFilter) {
                typeFilter.addEventListener('change', async function() {
                    console.log('Type filter changed to:', this.value);
                    updateCategoryFilter();
                    await loadTransactions();
                });
            } else {
                console.error('typeFilter element not found');
            }
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', async function() {
                    console.log('Category filter changed to:', this.value);
                    await loadTransactions();
                });
            } else {
                console.error('categoryFilter element not found');
            }
            
            // Month navigation buttons
            document.getElementById('prevMonthBtn').addEventListener('click', navigateToPreviousMonth);
            document.getElementById('nextMonthBtn').addEventListener('click', navigateToNextMonth);
            
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
            
            // Close modal on outside click
            document.getElementById('transactionModal').addEventListener('click', (e) => {
                if (e.target.id === 'transactionModal') {
                    closeModal();
                }
            });
        });
        
        function populateCategoryDropdowns() {
            // Populate filter dropdown with all categories
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            // Update transaction form category based on type
            updateCategoryDropdown();
        }
        
        function updateCategoryDropdown() {
            const transactionCategory = document.getElementById('transactionCategory');
            const transactionType = document.getElementById('transactionType').value;
            
            // Clear existing options except the first one
            transactionCategory.innerHTML = '<option value="">Select Category</option>';
            
            // Get appropriate categories based on type
            const categories = transactionType === 'income' ? incomeCategories : expenseCategories;
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                transactionCategory.appendChild(option);
            });
        }
        
        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const typeFilter = document.getElementById('typeFilter').value;
            const currentValue = categoryFilter.value;
            
            // Clear existing options
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            // Get appropriate categories based on type filter
            let categories = allCategories;
            if (typeFilter === 'income') {
                categories = incomeCategories;
            } else if (typeFilter === 'expense') {
                categories = expenseCategories;
            }
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            // Restore previous selection if it's still valid
            if (currentValue && categories.includes(currentValue)) {
                categoryFilter.value = currentValue;
            } else {
                categoryFilter.value = '';
            }
        }
        
        async function loadBudgetData() {
            try {
                const month = document.getElementById('monthFilter').value;
                const [year, monthNum] = month ? month.split('-') : [null, null];
                
                // Update the selected month display in header
                updateSelectedMonthDisplay(month);
                
                // Load summary - use month filter for summary cards (they should show selected month)
                const summaryParams = {};
                if (year) summaryParams.year = year;
                if (monthNum) summaryParams.month = monthNum;
                
                console.log('Loading summary with params:', summaryParams);
                const summaryResponse = await window.api.getTransactionSummary(summaryParams);
                console.log('Summary response:', summaryResponse);
                
                if (summaryResponse.success) {
                    summary = summaryResponse.data;
                    console.log('Summary data:', summary);
                    updateSummaryCards();
                } else {
                    console.error('Summary API returned success: false', summaryResponse);
                    // Set empty summary if API fails
                    summary = {
                        total_income: 0,
                        total_expenses: 0
                    };
                    updateSummaryCards();
                }
                
                // Also calculate summary from transactions filtered by month
                const monthTransactionsParams = {};
                if (year) monthTransactionsParams.year = year;
                if (monthNum) monthTransactionsParams.month = monthNum;
                
                const monthTransactionsResponse = await window.api.getTransactions(monthTransactionsParams);
                if (monthTransactionsResponse.success) {
                    const monthTransactions = monthTransactionsResponse.data || [];
                    
                    // If no transactions, set summary to 0
                    if (monthTransactions.length === 0) {
                        summary = {
                            total_income: 0,
                            total_expenses: 0
                        };
                    } else {
                        const calculatedIncome = monthTransactions
                            .filter(t => t.type === 'income')
                            .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                        const calculatedExpenses = monthTransactions
                            .filter(t => t.type === 'expense')
                            .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                        
                        summary = {
                            total_income: calculatedIncome,
                            total_expenses: calculatedExpenses
                        };
                    }
                    
                    console.log('Calculated summary from month transactions:', summary);
                    updateSummaryCards();
                } else {
                    // If API fails, set summary to 0
                    summary = {
                        total_income: 0,
                        total_expenses: 0
                    };
                    updateSummaryCards();
                }
                
                // Load transactions (filtered by month/type/category for display)
                await loadTransactions();
                
                // Load transactions for the selected month to calculate charts
                // Charts should show data only for the selected month
                try {
                    const monthTransactionsParams = {};
                    if (year) monthTransactionsParams.year = year;
                    if (monthNum) monthTransactionsParams.month = monthNum;
                    
                    const monthTransactionsResponse = await window.api.getTransactions(monthTransactionsParams);
                    if (monthTransactionsResponse.success) {
                        let monthTransactions = monthTransactionsResponse.data || [];
                        console.log('Month transactions for charts (before filter):', monthTransactions.length);
                        
                        // Additional frontend filtering by month to ensure accuracy
                        if (year && monthNum) {
                            monthTransactions = monthTransactions.filter(t => {
                                if (!t.date) return false;
                                const transactionDate = new Date(t.date);
                                const transactionYear = transactionDate.getFullYear();
                                const transactionMonth = transactionDate.getMonth() + 1;
                                return transactionYear == year && transactionMonth == monthNum;
                            });
                            console.log('Month transactions for charts (after filter):', monthTransactions.length);
                        }
                        
                        // If no transactions after filtering, show empty charts
                        if (monthTransactions.length === 0) {
                            console.log('No transactions for this month, showing empty charts');
                            updateCharts({});
                        } else {
                            // Try to get reports from API for the selected month
                            try {
                                const reportsParams = {};
                                if (year) reportsParams.year = year;
                                if (monthNum) reportsParams.month = monthNum;
                                
                                const reportsResponse = await window.api.getTransactionReports(reportsParams);
                                console.log('Reports response (month transactions):', reportsResponse);
                                if (reportsResponse.success && reportsResponse.data) {
                                    const categoryData = reportsResponse.data?.category_breakdown || {};
                                    const timelineData = reportsResponse.data?.daily_spending || {};
                                    
                                    // Check if reports have data
                                    const hasCategoryData = Object.keys(categoryData).length > 0 && Object.values(categoryData).some(v => v > 0);
                                    const hasTimelineData = Object.keys(timelineData).length > 0 && Object.values(timelineData).some(v => v > 0);
                                    
                                    if (hasCategoryData || hasTimelineData) {
                                        console.log('Using API reports data for charts');
                                        updateCharts(reportsResponse.data);
                                    } else {
                                        // Calculate from transactions if reports are empty
                                        console.log('Reports empty, calculating from transactions');
                                        updateChartsFromTransactions(monthTransactions, year, monthNum);
                                    }
                                } else {
                                    // Calculate from transactions if reports fail
                                    console.log('Reports failed, calculating from transactions');
                                    updateChartsFromTransactions(monthTransactions, year, monthNum);
                                }
                            } catch (error) {
                                console.error('Error loading reports, calculating from transactions:', error);
                                // Calculate from transactions on error
                                updateChartsFromTransactions(monthTransactions, year, monthNum);
                            }
                        }
                    } else {
                        // No transactions found for this month
                        console.log('API returned success: false, showing empty charts');
                        updateCharts({});
                    }
                } catch (error) {
                    console.error('Error loading transactions for charts:', error);
                    updateCharts({});
                }
                
                // Ensure summary is set to 0 if no transactions were found
                if (!summary || (summary.total_income === 0 && summary.total_expenses === 0)) {
                    summary = {
                        total_income: 0,
                        total_expenses: 0
                    };
                    updateSummaryCards();
                }
            } catch (error) {
                console.error('Error loading budget data:', error);
            }
        }
        
        async function loadTransactions() {
            try {
                const transactionsList = document.getElementById('transactionsList');
                const emptyState = document.getElementById('emptyState');
                
                // Show loading state
                transactionsList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i><p class="text-gray-500 mt-2">Loading transactions...</p></div>';
                emptyState.classList.add('hidden');
                
                const type = document.getElementById('typeFilter').value;
                const category = document.getElementById('categoryFilter').value;
                const month = document.getElementById('monthFilter').value;
                
                console.log('Loading transactions with filters:', { type, category, month });
                
                const params = {};
                if (type) params.type = type;
                if (category) params.category = category;
                if (month) {
                    const [year, monthNum] = month.split('-');
                    params.year = year;
                    params.month = monthNum;
                }
                
                console.log('API params:', params);
                
                const response = await window.api.getTransactions(params);
                console.log('API response:', response);
                
                if (response.success) {
                    transactions = response.data || [];
                    console.log('Loaded transactions:', transactions.length);
                    console.log('Month filter applied:', month);
                    console.log('Transactions dates:', transactions.map(t => ({ id: t.id, date: t.date })));
                    
                    // Additional frontend filtering by month to ensure accuracy
                    if (month) {
                        const [year, monthNum] = month.split('-');
                        transactions = transactions.filter(t => {
                            if (!t.date) return false;
                            const transactionDate = new Date(t.date);
                            const transactionYear = transactionDate.getFullYear();
                            const transactionMonth = transactionDate.getMonth() + 1;
                            return transactionYear == year && transactionMonth == monthNum;
                        });
                        console.log('After frontend month filter:', transactions.length);
                    }
                    
                    // If no transactions, ensure empty state is shown
                    if (transactions.length === 0) {
                        transactions = [];
                        displayTransactions();
                    } else {
                        displayTransactions();
                    }
                } else {
                    console.error('API returned success: false', response);
                    transactions = [];
                    transactionsList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                const transactionsList = document.getElementById('transactionsList');
                const emptyState = document.getElementById('emptyState');
                transactionsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                alert('Failed to load transactions: ' + (error.message || 'Unknown error'));
            }
        }
        
        function updateSummaryCards() {
            const totalIncome = summary?.total_income || 0;
            const totalExpenses = summary?.total_expenses || 0;
            const netBalance = totalIncome - totalExpenses;
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('netBalance').textContent = formatCurrency(netBalance);
            
            // Update net balance color
            const netBalanceEl = document.getElementById('netBalance');
            const netBalanceCard = netBalanceEl.closest('.stat-card');
            if (netBalance >= 0) {
                netBalanceCard.className = 'stat-card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg';
            } else {
                netBalanceCard.className = 'stat-card bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-xl shadow-lg';
            }
            
        }
        
        function updateChartsFromTransactions(monthTransactions, year, monthNum) {
            console.log('Calculating charts from transactions:', monthTransactions);
            console.log('Year:', year, 'Month:', monthNum);
            
            // Additional frontend filtering by month to ensure accuracy
            let filteredTransactions = monthTransactions;
            if (year && monthNum) {
                filteredTransactions = monthTransactions.filter(t => {
                    if (!t.date) return false;
                    const transactionDate = new Date(t.date);
                    const transactionYear = transactionDate.getFullYear();
                    const transactionMonth = transactionDate.getMonth() + 1;
                    return transactionYear == year && transactionMonth == monthNum;
                });
                console.log('Filtered transactions for charts:', filteredTransactions.length);
            }
            
            // Filter only expense transactions
            const expenses = filteredTransactions.filter(t => t.type === 'expense');
            console.log('Expense transactions:', expenses.length);
            
            if (expenses.length === 0) {
                console.log('No expenses found, showing empty charts');
                updateCharts({});
                return;
            }
            
            // Calculate category breakdown
            const categoryBreakdown = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                const amount = parseFloat(expense.amount || 0);
                categoryBreakdown[category] = (categoryBreakdown[category] || 0) + amount;
            });
            
            // Calculate daily spending for the selected month
            const dailySpending = {};
            
            if (year && monthNum) {
                // Get all days in the selected month
                const selectedDate = new Date(parseInt(year), parseInt(monthNum) - 1, 1);
                const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();
                
                // Initialize all days in the month with 0
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(parseInt(year), parseInt(monthNum) - 1, day);
                    const dateKey = date.toISOString().split('T')[0];
                    dailySpending[dateKey] = 0;
                }
                
                // Add actual spending data
                expenses.forEach(expense => {
                    const expenseDate = new Date(expense.date);
                    const expenseYear = expenseDate.getFullYear();
                    const expenseMonth = expenseDate.getMonth() + 1;
                    
                    // Only include expenses from the selected month
                    if (expenseYear == year && expenseMonth == monthNum) {
                        const dateKey = expenseDate.toISOString().split('T')[0];
                        const amount = parseFloat(expense.amount || 0);
                        dailySpending[dateKey] = (dailySpending[dateKey] || 0) + amount;
                    }
                });
            } else {
                // Fallback: last 30 days if no month selected
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                expenses.forEach(expense => {
                    const expenseDate = new Date(expense.date);
                    if (expenseDate >= thirtyDaysAgo && expenseDate <= today) {
                        const dateKey = expenseDate.toISOString().split('T')[0];
                        const amount = parseFloat(expense.amount || 0);
                        dailySpending[dateKey] = (dailySpending[dateKey] || 0) + amount;
                    }
                });
            }
            
            const reportsData = {
                category_breakdown: categoryBreakdown,
                daily_spending: dailySpending
            };
            
            console.log('Calculated reports data:', reportsData);
            console.log('Category breakdown keys:', Object.keys(categoryBreakdown));
            console.log('Daily spending keys:', Object.keys(dailySpending));
            updateCharts(reportsData);
        }
        
        function updateCharts(reportsData) {
            console.log('Updating charts with data:', reportsData);
            console.log('Category breakdown:', reportsData?.category_breakdown);
            console.log('Daily spending:', reportsData?.daily_spending);
            
            // Destroy existing charts first
            if (categoryChart) {
                try {
                    categoryChart.destroy();
                } catch (e) {
                    console.warn('Error destroying category chart:', e);
                }
                categoryChart = null;
            }
            if (timelineChart) {
                try {
                    timelineChart.destroy();
                } catch (e) {
                    console.warn('Error destroying timeline chart:', e);
                }
                timelineChart = null;
            }
            
            // Find chart containers reliably
            // Get all chart sections
            const chartSections = document.querySelectorAll('.bg-white.rounded-xl.shadow-sm.p-6');
            let categoryChartArea = null;
            let timelineChartArea = null;
            
            // Find category chart container by looking for the h3 title
            for (let section of chartSections) {
                const h3 = section.querySelector('h3');
                if (h3 && h3.textContent.includes('Spending by Category')) {
                    categoryChartArea = section.querySelector('.h-64');
                    break;
                }
            }
            
            // Find timeline chart container
            for (let section of chartSections) {
                const h3 = section.querySelector('h3');
                if (h3 && h3.textContent.includes('Spending Over Time')) {
                    timelineChartArea = section.querySelector('.h-64');
                    break;
                }
            }
            
            // Fallback: use array index if not found
            if (!categoryChartArea && chartSections[0]) {
                categoryChartArea = chartSections[0].querySelector('.h-64');
            }
            if (!timelineChartArea && chartSections[1]) {
                timelineChartArea = chartSections[1].querySelector('.h-64');
            }
            
            // Category Pie Chart - Only show expenses
            const categoryData = reportsData?.category_breakdown || {};
            const categoryLabels = Object.keys(categoryData).filter(key => categoryData[key] > 0);
            const categoryValues = categoryLabels.map(key => categoryData[key]);
            
            console.log('Category labels:', categoryLabels);
            console.log('Category values:', categoryValues);
            console.log('Category chart area found:', !!categoryChartArea);
            
            if (categoryChartArea) {
                if (categoryLabels.length === 0 || categoryValues.every(v => v === 0)) {
                    // No data - show message
                    categoryChartArea.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <i class="fas fa-chart-pie text-4xl mb-2"></i>
                            <p class="text-sm">No spending data available for this month</p>
                            <p class="text-xs mt-1">Add expense transactions to see category breakdown</p>
                        </div>
                    `;
                } else {
                    // Restore canvas
                    categoryChartArea.innerHTML = '<canvas id="categoryChart"></canvas>';
                    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                    categoryChart = new Chart(categoryCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: [
                                '#3b82f6', '#ef4444', '#10b981', '#f59e0b',
                                '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                }
            }
            
            // Timeline Bar Chart - Only show expenses
            const timelineData = reportsData?.daily_spending || {};
            const timelineLabels = Object.keys(timelineData).sort();
            const timelineValues = timelineLabels.map(date => timelineData[date] || 0);
            const hasTimelineData = timelineLabels.length > 0 && timelineValues.some(v => v > 0);
            
            // Update chart title based on selected month
            const monthFilter = document.getElementById('monthFilter').value;
            const timelineChartTitle = document.getElementById('timelineChartTitle');
            if (monthFilter) {
                const [year, monthNum] = monthFilter.split('-');
                const monthName = new Date(parseInt(year), parseInt(monthNum) - 1, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                timelineChartTitle.textContent = `Spending Over Time - ${monthName}`;
            } else {
                timelineChartTitle.textContent = 'Spending Over Time (Last 30 Days)';
            }
            
            console.log('Timeline data check:', {
                hasTimelineData,
                timelineLabels: timelineLabels.length,
                timelineValues: timelineValues.length,
                someValues: timelineValues.some(v => v > 0)
            });
            
            if (timelineChartArea) {
                if (!hasTimelineData) {
                    // No data - show message
                    timelineChartArea.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <i class="fas fa-chart-bar text-4xl mb-2"></i>
                            <p class="text-sm">No spending data available for this month</p>
                            <p class="text-xs mt-1">Add expense transactions to see spending timeline</p>
                        </div>
                    `;
                } else {
                    // Restore canvas
                    timelineChartArea.innerHTML = '<canvas id="timelineChart"></canvas>';
                    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
                    timelineChart = new Chart(timelineCtx, {
                    type: 'bar',
                    data: {
                        labels: timelineLabels.map(date => {
                            const d = new Date(date);
                            return `${d.getMonth() + 1}/${d.getDate()}`;
                        }),
                        datasets: [{
                            label: 'Spending',
                            data: timelineValues,
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                }
            }
        }
        
        function displayTransactions() {
            const list = document.getElementById('transactionsList');
            const emptyState = document.getElementById('emptyState');
            
            // Apply frontend filtering as backup (in case backend doesn't filter)
            let filteredTransactions = transactions;
            const typeFilter = document.getElementById('typeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            // Filter by month first
            if (monthFilter) {
                const [year, monthNum] = monthFilter.split('-');
                filteredTransactions = filteredTransactions.filter(t => {
                    if (!t.date) return false;
                    const transactionDate = new Date(t.date);
                    const transactionYear = transactionDate.getFullYear();
                    const transactionMonth = transactionDate.getMonth() + 1;
                    return transactionYear == year && transactionMonth == monthNum;
                });
            }
            
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            if (categoryFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.category === categoryFilter);
            }
            
            console.log('Displaying transactions:', {
                total: transactions.length,
                filtered: filteredTransactions.length,
                typeFilter,
                categoryFilter,
                monthFilter
            });
            
            if (filteredTransactions.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                // Update empty state message based on filters
                const monthFilter = document.getElementById('monthFilter').value;
                const emptyStateText = emptyState.querySelector('p.text-gray-500');
                if (monthFilter) {
                    const [year, monthNum] = monthFilter.split('-');
                    const monthName = new Date(parseInt(year), parseInt(monthNum) - 1, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    emptyStateText.textContent = `No transactions found for ${monthName}`;
                } else {
                    emptyStateText.textContent = 'No transactions found';
                }
                return;
            }
            
            emptyState.classList.add('hidden');
            
            list.innerHTML = filteredTransactions.map(transaction => {
                const isIncome = transaction.type === 'income';
                const icon = isIncome ? 'fa-arrow-up text-green-600' : 'fa-arrow-down text-red-600';
                const bgColor = isIncome ? 'bg-green-50' : 'bg-red-50';
                const textColor = isIncome ? 'text-green-700' : 'text-red-700';
                
                return `
                    <div class="transaction-item bg-white border-l-4 ${isIncome ? 'border-green-500' : 'border-red-500'} rounded-lg p-4 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="${bgColor} w-12 h-12 rounded-lg flex items-center justify-center">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-semibold text-gray-800">${escapeHtml(transaction.category || 'Uncategorized')}</h4>
                                        <span class="px-2 py-0.5 ${textColor} ${bgColor} rounded text-xs font-medium">${transaction.type}</span>
                                    </div>
                                    ${transaction.note ? `<p class="text-sm text-gray-500">${escapeHtml(transaction.note)}</p>` : ''}
                                    <p class="text-xs text-gray-400 mt-1">${formatDate(transaction.date)}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <p class="text-lg font-bold ${textColor}">${isIncome ? '+' : '-'}${formatCurrency(transaction.amount)}</p>
                                <div class="flex gap-2">
                                    <button onclick="editTransaction(${transaction.id})" class="p-2 text-gray-400 hover:text-blue-600 transition">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTransaction(${transaction.id})" class="p-2 text-gray-400 hover:text-red-600 transition">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openModal(transaction = null) {
            editingTransactionId = transaction ? transaction.id : null;
            const modal = document.getElementById('transactionModal');
            const form = document.getElementById('transactionForm');
            const title = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitBtnText');
            
            if (transaction) {
                title.textContent = 'Edit Transaction';
                submitBtn.textContent = 'Update Transaction';
                document.getElementById('transactionType').value = transaction.type;
                // Update category dropdown first, then set the value
                updateCategoryDropdown();
                document.getElementById('transactionCategory').value = transaction.category || '';
                document.getElementById('transactionAmount').value = transaction.amount;
                
                // Format date for date input (YYYY-MM-DD)
                let dateValue = transaction.date;
                if (dateValue) {
                    // If date includes time, extract just the date part
                    if (dateValue.includes('T')) {
                        dateValue = dateValue.split('T')[0];
                    }
                    // Ensure it's in YYYY-MM-DD format
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        dateValue = `${year}-${month}-${day}`;
                    }
                }
                document.getElementById('transactionDate').value = dateValue || '';
                
                document.getElementById('transactionNote').value = transaction.note || '';
            } else {
                title.textContent = 'Add Transaction';
                submitBtn.textContent = 'Add Transaction';
                form.reset();
                document.getElementById('transactionDate').valueAsDate = new Date();
                // Set default type and update categories
                document.getElementById('transactionType').value = 'expense';
                updateCategoryDropdown();
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            editingTransactionId = null;
            document.getElementById('transactionForm').reset();
        }
        
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Validate form
            const type = document.getElementById('transactionType').value;
            const category = document.getElementById('transactionCategory').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const date = document.getElementById('transactionDate').value;
            const note = document.getElementById('transactionNote').value.trim();
            
            if (!type || !category || !amount || !date) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (amount <= 0) {
                alert('Amount must be greater than 0.');
                return;
            }
            
            const data = {
                type: type,
                category: category,
                amount: amount,
                date: date
            };
            
            // Only include note if it's not empty
            if (note) {
                data.note = note;
            }
            
            console.log('Submitting transaction data:', data);
            
            try {
                let response;
                if (editingTransactionId) {
                    response = await window.api.updateTransaction(editingTransactionId, data);
                } else {
                    response = await window.api.createTransaction(data);
                }
                
                console.log('Transaction saved successfully:', response);
                
                if (response.success) {
                    closeModal();
                    await loadBudgetData();
                } else {
                    throw new Error(response.message || 'Failed to save transaction');
                }
            } catch (error) {
                console.error('Error saving transaction:', error);
                console.error('Error details:', {
                    message: error.message,
                    status: error.status,
                    data: error.data,
                    error: error.error
                });
                
                // Extract error message
                let errorMessage = 'Failed to save transaction. Please try again.';
                
                if (error.data) {
                    // Laravel validation errors
                    if (error.data.errors) {
                        const errors = Object.values(error.data.errors).flat();
                        errorMessage = errors.join('\n');
                    } else if (error.data.message) {
                        errorMessage = error.data.message;
                    }
                } else if (error.message) {
                    errorMessage = error.message;
                } else if (error.error) {
                    if (typeof error.error === 'string') {
                        errorMessage = error.error;
                    } else if (error.error.message) {
                        errorMessage = error.error.message;
                    } else if (error.error.errors) {
                        const errors = Object.values(error.error.errors).flat();
                        errorMessage = errors.join('\n');
                    }
                }
                
                alert(errorMessage);
            }
        }
        
        async function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                openModal(transaction);
            }
        }
        
        async function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }
            
            try {
                await window.api.deleteTransaction(id);
                await loadBudgetData();
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('Failed to delete transaction. Please try again.');
            }
        }
        
        function updateSelectedMonthDisplay(monthValue) {
            const displayElement = document.getElementById('selectedMonthDisplay');
            const currentMonthDisplay = document.getElementById('currentMonthDisplay');
            
            if (monthValue) {
                const [year, monthNum] = monthValue.split('-');
                const monthName = new Date(parseInt(year), parseInt(monthNum) - 1, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                displayElement.textContent = `Showing data for ${monthName}`;
                currentMonthDisplay.textContent = monthName;
            } else {
                displayElement.textContent = 'Track your income and expenses';
                currentMonthDisplay.textContent = '';
            }
        }
        
        function navigateToPreviousMonth() {
            const monthFilter = document.getElementById('monthFilter');
            const currentValue = monthFilter.value || new Date().toISOString().slice(0, 7);
            const [year, monthNum] = currentValue.split('-');
            
            let newYear = parseInt(year);
            let newMonth = parseInt(monthNum) - 1;
            
            if (newMonth < 1) {
                newMonth = 12;
                newYear -= 1;
            }
            
            const newMonthValue = `${newYear}-${String(newMonth).padStart(2, '0')}`;
            monthFilter.value = newMonthValue;
            updateSelectedMonthDisplay(newMonthValue);
            loadBudgetData();
        }
        
        function navigateToNextMonth() {
            const monthFilter = document.getElementById('monthFilter');
            const currentValue = monthFilter.value || new Date().toISOString().slice(0, 7);
            const [year, monthNum] = currentValue.split('-');
            
            let newYear = parseInt(year);
            let newMonth = parseInt(monthNum) + 1;
            
            if (newMonth > 12) {
                newMonth = 1;
                newYear += 1;
            }
            
            const newMonthValue = `${newYear}-${String(newMonth).padStart(2, '0')}`;
            monthFilter.value = newMonthValue;
            updateSelectedMonthDisplay(newMonthValue);
            loadBudgetData();
        }
        
        function clearFilters() {
            document.getElementById('typeFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthFilter').value = currentMonth;
            updateCategoryFilter();
            updateSelectedMonthDisplay(currentMonth);
            loadBudgetData();
        }
        
        // Function to go to current month
        function goToCurrentMonth() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthFilter').value = currentMonth;
            updateSelectedMonthDisplay(currentMonth);
            loadBudgetData();
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                window.api.logout().then(() => {
                    window.location.href = 'login.html';
                });
            }
        }
        
        // Make functions globally available for onclick handlers
        window.editTransaction = editTransaction;
        window.deleteTransaction = deleteTransaction;
    </script>
</body>
</html>